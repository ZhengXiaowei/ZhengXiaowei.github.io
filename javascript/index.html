<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端缓存 | Xiao Blog</title>
    <meta name="description" content="axios封装的接口缓存">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    <meta name="keywords" content="axios 缓存 接口缓存 cache">
    <link rel="preload" href="/assets/css/31.styles.72922159.css" as="style"><link rel="preload" href="/assets/js/app.a03d4e4f.js" as="script"><link rel="preload" href="/assets/js/23.c0b205ad.js" as="script"><link rel="prefetch" href="/assets/js/0.0f59b883.js"><link rel="prefetch" href="/assets/js/1.9796cf5f.js"><link rel="prefetch" href="/assets/js/2.2a946d02.js"><link rel="prefetch" href="/assets/js/3.59a83de8.js"><link rel="prefetch" href="/assets/js/4.21fdbdec.js"><link rel="prefetch" href="/assets/js/5.a09ec324.js"><link rel="prefetch" href="/assets/js/6.d6543f82.js"><link rel="prefetch" href="/assets/js/7.3de0ccee.js"><link rel="prefetch" href="/assets/js/8.88711e9b.js"><link rel="prefetch" href="/assets/js/9.338fb1f3.js"><link rel="prefetch" href="/assets/js/10.538a23d4.js"><link rel="prefetch" href="/assets/js/11.55badfb5.js"><link rel="prefetch" href="/assets/js/12.6f950838.js"><link rel="prefetch" href="/assets/js/13.5399a19b.js"><link rel="prefetch" href="/assets/js/14.451eca1f.js"><link rel="prefetch" href="/assets/js/15.35ff6acf.js"><link rel="prefetch" href="/assets/js/16.ece38f4c.js"><link rel="prefetch" href="/assets/js/17.3bcb6de9.js"><link rel="prefetch" href="/assets/js/18.74c09d5d.js"><link rel="prefetch" href="/assets/js/19.aa302882.js"><link rel="prefetch" href="/assets/js/20.d26e17c2.js"><link rel="prefetch" href="/assets/js/21.140f1446.js"><link rel="prefetch" href="/assets/js/22.d56b6200.js"><link rel="prefetch" href="/assets/js/24.e3ca6758.js"><link rel="prefetch" href="/assets/js/25.5bbdea6c.js"><link rel="prefetch" href="/assets/js/26.15fba687.js"><link rel="prefetch" href="/assets/js/27.36d4982c.js"><link rel="prefetch" href="/assets/js/28.ef10919f.js"><link rel="prefetch" href="/assets/js/29.1fd2d94f.js"><link rel="prefetch" href="/assets/js/30.152778aa.js">
    <link rel="stylesheet" href="/assets/css/31.styles.72922159.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Xiao Blog
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><!----></div></header><div class="sidebar-mask"></div><div class="sidebar"><!----><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>JavaScript</span><!----></p><ul class="sidebar-group-items"><li><a href="/javascript/" class="active sidebar-link">前端缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/javascript/#怎么做" class="sidebar-link">怎么做?</a></li><li class="sidebar-sub-header"><a href="/javascript/#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/javascript/#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/javascript/#简单封装" class="sidebar-link">简单封装</a></li><li class="sidebar-sub-header"><a href="/javascript/#打包-npm" class="sidebar-link">打包 npm</a></li><li class="sidebar-sub-header"><a href="/javascript/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/javascript/partner.html" class="sidebar-link">设计模式</a></li><li><a href="/javascript/canvas.html" class="sidebar-link">canvas踩坑记</a></li><li><a href="/javascript/listview.html" class="sidebar-link">List-view 实现</a></li><li><a href="/javascript/typescript.html" class="sidebar-link">Typescript</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Vue</span><!----></p><ul class="sidebar-group-items"><li><a href="/vue/" class="sidebar-link">Vuex学习笔记</a></li><li><a href="/vue/vuex-persistence.html" class="sidebar-link">Vuex 持久化方案一</a></li><li><a href="/vue/vueMultipage.html" class="sidebar-link">vue多页配置</a></li><li><a href="/vue/optimize.html" class="sidebar-link">vue项目优化</a></li><li><a href="/vue/parcel-vue.html" class="sidebar-link">parcel-vue初体验</a></li><li><a href="/vue/sync-component.html" class="sidebar-link">异步组件</a></li><li><a href="/vue/rebuild.html" class="sidebar-link">重构Vue阅读器</a></li><li><a href="/vue/vue-tsx.html" class="sidebar-link">搭建vue-tsx风格的开发模板</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>WebApp</span><!----></p><ul class="sidebar-group-items"><li><a href="/webapp/" class="sidebar-link">cordova 打包</a></li><li><a href="/webapp/questions.html" class="sidebar-link">移动端问题锦集</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Flutter</span><!----></p><ul class="sidebar-group-items"><li><a href="/flutter/" class="sidebar-link">环境搭建</a></li><li><a href="/flutter/dart.html" class="sidebar-link">Dart基础语法</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Services</span><!----></p><ul class="sidebar-group-items"><li><a href="/services/" class="sidebar-link">Mongodb 好像有点意思？</a></li><li><a href="/services/mongodb.html" class="sidebar-link">正经学个mongoDB吧！</a></li><li><a href="/services/python.html" class="sidebar-link">学学Python吧~</a></li><li><a href="/services/mysql.html" class="sidebar-link">向mysql低头</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>其他</span><!----></p><ul class="sidebar-group-items"><li><a href="/others/" class="sidebar-link">VSCode 常用插件推荐</a></li><li><a href="/others/vsESlint.html" class="sidebar-link">VSCode ESLint 配置</a></li><li><a href="/others/nginx.html" class="sidebar-link">nginx服务器搭建</a></li><li><a href="/others/android-dev.html" class="sidebar-link">Mac 配置 Android 环境</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="前端缓存"><a href="#前端缓存" aria-hidden="true" class="header-anchor">#</a> 前端缓存</h1><div class="warning custom-block"><p class="custom-block-title">提示</p><p>这里讲的前端缓存是指前端对接口数据的缓存处理，而不是通过 HTTP(s)缓存</p></div><h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2><p>通常会在项目中有这么些情况发生，比如每次页面切换的时候都会请求接口，如果频繁切换，也就会导致接口频繁的请求，而且在数据基本没有什么变动的情况下，这样的做法明显是浪费网络资源的。所以我们出于考虑，要实现接口的缓存，避免频繁的去请求接口。如果后端同学不给于帮助的话。。。那我们就进入今天的主题--<code>前端缓存</code>。(当然，能 http 缓存就 http 缓存最好了~)</p><h2 id="怎么做"><a href="#怎么做" aria-hidden="true" class="header-anchor">#</a> 怎么做?</h2><blockquote><p>思路</p></blockquote><p>这里我们使用<code>axios</code>进行接口的请求，我们要用到<code>axios</code>的两个功能--<code>拦截器</code>和<code>cancleToken</code>。首先我们要使用拦截器，去拦截要发送的请求，然后对比我们本地缓存池，看是否有在缓存池中存在，如果存在，则使用<code>cancleToken</code>直接取消请求，并从缓存池从返回数据，如果不存在则正常请求，并在响应拦截器中将该条请求存入缓存池中。当然，我们还需要一个过期时间，如果过期，则重新请求，更新缓存池的数据，避免一直在缓存池中取老数据。</p><blockquote><p>流程</p></blockquote><p>具体流程图入下：
<img src="/assets/process.png"></p><div class="tip custom-block"><p class="custom-block-title">提示</p><p>上图右侧的俩响应拦截器其实同属一个拦截器，这里为了区分，所以拆分成俩。</p></div><h2 id="实现"><a href="#实现" aria-hidden="true" class="header-anchor">#</a> 实现</h2><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token comment">// 定义一个缓存池用来缓存数据</span>
<span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token constant">EXPIRE_TIME</span> <span class="token operator">=</span> <span class="token number">60000</span>
<span class="token comment">// 利用axios的cancelToken来取消请求</span>
<span class="token keyword">const</span> CancelToken <span class="token operator">=</span> axios<span class="token punctuation">.</span>CancelToken

<span class="token comment">// 请求拦截器中用于判断数据是否存在以及过期 未过期直接返回</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果需要缓存--考虑到并不是所有接口都需要缓存的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> source <span class="token operator">=</span> CancelToken<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>cancelToken <span class="token operator">=</span> source<span class="token punctuation">.</span>token
    <span class="token comment">// 去缓存池获取缓存数据</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> cache<span class="token punctuation">[</span>config<span class="token punctuation">.</span>url<span class="token punctuation">]</span>
    <span class="token comment">// 获取当前时间戳</span>
    <span class="token keyword">let</span> expire_time <span class="token operator">=</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 判断缓存池中是否存在已有数据 存在的话 再判断是否过期</span>
    <span class="token comment">// 未过期 source.cancel会取消当前的请求 并将内容返回到拦截器的err中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> expire_time <span class="token operator">-</span> data<span class="token punctuation">.</span>expire <span class="token operator">&lt;</span> <span class="token constant">EXPIRE_TIME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      source<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> config
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 响应拦截器中用于缓存数据 如果数据没有缓存的话</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  response <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只缓存get请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>config<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'get'</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>config<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 缓存数据 并将当前时间存入 方便之后判断是否过期</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        expire<span class="token punctuation">:</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> response<span class="token punctuation">.</span>data
      <span class="token punctuation">}</span>
      cache<span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response<span class="token punctuation">.</span>config<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> response
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求拦截器中的source.cancel会将内容发送到error中</span>
    <span class="token comment">// 通过axios.isCancel(error)来判断是否返回有数据 有的话直接返回给用户</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>axios<span class="token punctuation">.</span><span class="token function">isCancel</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token comment">// 如果没有的话 则是正常的接口错误 直接返回错误信息给用户</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// 获取当前时间</span>
<span class="token keyword">function</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">提示</p><p>之所以缓存逻辑写在响应拦截器中是因为只有在响应拦截器中可以得到接口返回的数据，而请求拦截器中，无法做到。</p></div><h2 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h2><p>然后页面中接口请求如下配置:</p><div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    i am page A
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>回首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'../utils/axios'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加上属性cache:true 则表示当前接口需要缓存（可以从缓存获取）</span>
    <span class="token function">axios</span><span class="token punctuation">(</span><span class="token string">'v2/book/1003078'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      cache<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>或者在统一的<code>api</code>接口管理文件中配置：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'./axios'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getBooks</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">axios</span><span class="token punctuation">(</span><span class="token string">'v2/book/1003078'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cache<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="简单封装"><a href="#简单封装" aria-hidden="true" class="header-anchor">#</a> 简单封装</h2><p>新建一个<code>cache.js</code></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 缓存池</span>
<span class="token keyword">let</span> <span class="token constant">CACHES</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>axios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>axios <span class="token operator">=</span> axios
    <span class="token keyword">this</span><span class="token punctuation">.</span>cancelToken <span class="token operator">=</span> axios<span class="token punctuation">.</span>CancelToken
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">use</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> defaults <span class="token operator">=</span> <span class="token punctuation">{</span>
      expire<span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">,</span> <span class="token comment">// 过期时间 默认一分钟</span>
      storage<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是否开启缓存</span>
      storage_expire<span class="token punctuation">:</span> <span class="token number">3600000</span><span class="token punctuation">,</span> <span class="token comment">// 本地缓存过期时间 默认一小时</span>
      instance<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>axios<span class="token punctuation">,</span> <span class="token comment">// axios的实例对象 默认指向当前axios</span>
      requestConfigFn<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 请求拦截的操作函数 参数为请求的config对象 返回一个Promise</span>
      responseConfigFn<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 响应拦截的操作函数 参数为响应数据的response对象 返回一个Promise</span>
      <span class="token operator">...</span>options
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> defaults
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// if (options &amp;&amp; !options.instance) return this.options.instance</span>
  <span class="token punctuation">}</span>

  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>storage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果开启本地缓存 则设置一个过期时间 避免时间过久 缓存一直存在</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_storageExpire</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token constant">CACHES</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token function">mapStorage</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>requestConfigFn<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>responseConfigFn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">request</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求拦截器</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options
    options<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断用户是否返回 config 的 promise</span>
      <span class="token keyword">let</span> newConfig <span class="token operator">=</span> cb <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">cb</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span>
      config <span class="token operator">=</span> newConfig <span class="token operator">||</span> config
      <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>cancelToken <span class="token operator">=</span> source<span class="token punctuation">.</span>token
        <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token constant">CACHES</span><span class="token punctuation">[</span>config<span class="token punctuation">.</span>url<span class="token punctuation">]</span>
        <span class="token keyword">let</span> expire <span class="token operator">=</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 判断缓存数据是否存在 存在的话 是否过期 没过期就返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> expire <span class="token operator">-</span> data<span class="token punctuation">.</span>expire <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          source<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> config
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">response</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 响应拦截器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
      <span class="token keyword">async</span> response <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断用户是否返回了 response 的 Promise</span>
        <span class="token keyword">let</span> newResponse <span class="token operator">=</span> cb <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">cb</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> newResponse <span class="token operator">||</span> response
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>config<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'get'</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>config<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
            expire<span class="token punctuation">:</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            data<span class="token punctuation">:</span> response
          <span class="token punctuation">}</span>
          <span class="token constant">CACHES</span><span class="token punctuation">[</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response<span class="token punctuation">.</span>config<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>storage<span class="token punctuation">)</span> <span class="token function">mapStorage</span><span class="token punctuation">(</span><span class="token constant">CACHES</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> response
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回缓存数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>axios<span class="token punctuation">.</span><span class="token function">isCancel</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 本地缓存过期判断</span>
  <span class="token function">_storageExpire</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token function">getStorage</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span>
      <span class="token keyword">let</span> date <span class="token operator">=</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 缓存存在 判断是否过期</span>
        <span class="token keyword">let</span> isExpire <span class="token operator">=</span> date <span class="token operator">-</span> key <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>storage_expire
        <span class="token comment">// 如果过期 则重新设定过期时间 并清空缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isExpire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">removeStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">setStorage</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> date<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * caches: 缓存列表
 * type: set-&gt;存 get-&gt;取
 */</span>
<span class="token keyword">function</span> <span class="token function">mapStorage</span><span class="token punctuation">(</span>caches<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'set'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>caches<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>key<span class="token punctuation">,</span> cache<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'set'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setStorage</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> cache<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 正则太弱 只能简单判断是否是json字符串</span>
      <span class="token keyword">let</span> reg <span class="token operator">=</span> <span class="token regex">/\{/g</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token constant">CACHES</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span>
      <span class="token keyword">else</span> <span class="token constant">CACHES</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> cache
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除本地缓存</span>
<span class="token keyword">function</span> <span class="token function">removeStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设置缓存</span>
<span class="token keyword">function</span> <span class="token function">setStorage</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取缓存</span>
<span class="token keyword">function</span> <span class="token function">getStorage</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 设置过期时间</span>
<span class="token keyword">function</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后在自定义的<code>axios.js</code>中引入</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">import</span> Cache <span class="token keyword">from</span> <span class="token string">'./cache2'</span>

<span class="token comment">// axios的自定义实例</span>
<span class="token keyword">let</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  baseURL<span class="token punctuation">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cache</span><span class="token punctuation">(</span>axios<span class="token punctuation">)</span> <span class="token comment">// 将当前 axios 对象传入 Cache 中</span>
cache<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  expire<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
  storage<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  instance<span class="token punctuation">,</span> <span class="token comment">// 如果有自定义axios实例 比如上面的instance 需要将其传入instance 没有则不传</span>
  requestConfigFn<span class="token punctuation">:</span> config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请求拦截自定义操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>header<span class="token punctuation">.</span>token <span class="token operator">=</span> <span class="token string">'i am token'</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>header <span class="token operator">=</span> <span class="token punctuation">{</span> token<span class="token punctuation">:</span> <span class="token string">'i am token'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 需要将config对象通过 Promise 返回 cache 中 也可以使用new Promise的写法</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  responseConfigFn<span class="token punctuation">:</span> res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 响应拦截的自定义操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 需要将 res 通过 Promise 返回</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> instance
</code></pre></div><h2 id="打包-npm"><a href="#打包-npm" aria-hidden="true" class="header-anchor">#</a> 打包 npm</h2><p>该工具已经打包至 NPM 库，可通过包命令安装：</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># npm</span>
<span class="token function">npm</span> <span class="token function">install</span> axios-request-cache --save

<span class="token comment"># yarn</span>
yarn add axios-request-cache
</code></pre></div><p><a href="https://github.com/ZhengXiaowei/axios-request-cache" target="_blank" rel="noopener noreferrer">项目传送门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2><ul><li><code>cache.js</code>可能还有些情况未考虑进去</li><li><code>requestConfigFn</code>和<code>responseConfigFn</code>能操作的空间可能也不够大</li></ul><p>后续还会继续优化</p></div><div class="page-edit"><!----><div class="last-updated"><span class="prefix">上次更新: </span><span class="time">8/31/2018, 5:52:20 PM</span></div></div><div class="page-nav"><p class="inner"><!----><span class="next"><a href="/javascript/partner.html">
          设计模式
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/23.c0b205ad.js" defer></script><script src="/assets/js/app.a03d4e4f.js" defer></script>
  </body>
</html>
